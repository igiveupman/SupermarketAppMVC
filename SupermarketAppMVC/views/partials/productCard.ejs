<% /* Reusable product card partial. Expects locals: p (product), user, returnTo (optional), showFavorite (bool), clickable (bool) */ %>
<div class="product-card <%= clickable ? 'clickable' : '' %>" <%= clickable ? ('data-link="/product/' + p.id + '"') : '' %>>
  <div class="d-flex justify-content-between align-items-start mb-1">
    <div class="product-meta"><%= (p.category === 'Produce' || p.category === 'Fruits and Vegetables') ? 'Fruits & Veg' : (p.category || 'Uncategorized') %></div>
    <% if (showFavorite && user) { %>
      <a href="/favorites/toggle/<%= p.id %>" class="favorite-toggle" title="Toggle favorite" onclick="event.stopPropagation()">
        <span class="heart <%= p.favorited ? 'favorited' : '' %>"><%- p.favorited ? '&#10084;' : '&#9825;' %></span>
      </a>
    <% } %>
  </div>
  <a href="/product/<%= p.id %>" class="text-decoration-none" onclick="event.stopPropagation()"><h5><%= p.productName %></h5></a>
  <% if (typeof p.averageRating !== 'undefined') {
    const avg = p.averageRating ? Number(p.averageRating).toFixed(1) : null;
    const avgNum = avg ? Number(avg) : 0;
    const fullStars = avg ? Math.floor(avgNum) : 0;
    const halfStar = avg ? (avgNum - fullStars) >= 0.5 : false;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
  %>
    <div class="d-flex align-items-center gap-1 mb-1 rating-row">
      <% if (avg) { %><span class="avg-score"><%= avg %></span><% } %>
      <div class="star-row">
        <% for (let i = 0; i < fullStars; i++) { %><span class="star full">&#9733;</span><% } %>
        <% if (halfStar) { %><span class="star half">&#9733;</span><% } %>
        <% for (let i = 0; i < emptyStars; i++) { %><span class="star empty">&#9733;</span><% } %>
      </div>
      <small class="text-muted"><%= (p.reviewCount || 0) %></small>
    </div>
  <% } %>
  <img src="/images/<%= p.image %>" alt="<%= p.productName %>" onclick="event.stopPropagation()">
  <div class="price-tag">
    <% if (p.discount_price) { %>
      <span class="price-discount">$<%= Number(p.discount_price).toFixed(2) %></span>
      <span class="price-original ms-1">$<%= Number(p.price).toFixed(2) %></span>
    <% } else { %>
      $<%= Number(p.price).toFixed(2) %>
    <% } %>
  </div>
  <div class="stock">
    <% if (p.quantity > 0) { %>
      Stock: <%= p.quantity %>
    <% } else { %>
      <span class="badge bg-danger">Sold Out</span>
    <% } %>
  </div>
  <% if (user && user.role !== 'admin') { %>
    <% if (p.quantity > 0) { %>
      <form action="/add-to-cart/<%= p.id %>" method="POST" class="mt-auto" onclick="event.stopPropagation()">
        <input type="hidden" name="returnTo" value="<%= returnTo || '/shopping' %>">
        <div class="input-group mb-2">
          <input type="number" name="quantity" class="form-control qty-input" data-max="<%= p.quantity %>" min="1" max="<%= p.quantity %>" value="1" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">&#128722; Add to Cart</button>
      </form>
    <% } else { %>
      <button class="btn btn-secondary w-100 mt-auto" disabled>Not Available</button>
    <% } %>
  <% } %>
</div>
<style>
  .product-card img { object-fit: cover; width: 100%; max-height: 180px; border-radius: 8px; margin: 0.25rem 0 0.5rem; }
  .product-meta { font-size: .75rem; text-transform: uppercase; letter-spacing: .6px; color: #6b7280; }
  .favorite-toggle { text-decoration: none; color: #cbd5e1; transition: .2s; }
  .favorite-toggle .heart.favorited { color: #e11d48; }
  .price-discount { color: #16a34a; font-weight: 700; }
  .price-original { text-decoration: line-through; color: #6b7280; }
  .stock { font-size: .9rem; color: #4b5563; margin-bottom: .75rem; }
  .qty-input { max-width: 100%; }
  .product-card.clickable { cursor: pointer; }
  .rating-row .avg-score { font-weight: 700; color: #2563eb; }
  .rating-row .star-row .star { font-size: .9rem; }
  .rating-row .star.full { color: #f59e0b; }
  .rating-row .star.half { color: #f59e0b; position: relative; }
  .rating-row .star.half::after { content: 'â˜…'; color: #e5e7eb; position: absolute; left: 0; width: 50%; overflow: hidden; }
  .rating-row .star.empty { color: #e5e7eb; }
</style>
