<%- include('partials/header', { user, pageTitle: 'Payment Success' }) %>
<div class="text-center py-5">
  <div style="font-size:72px; line-height:1;">âœ…</div>
  <h2 class="mt-3">Your Payment was Successful</h2>
  <p class="text-muted mb-4">Thank you! Your order has been placed.</p>
  <a href="/orders" class="btn btn-primary">View Orders</a>
  <% if (typeof lastOrderId !== 'undefined' && lastOrderId) { %>
    <a href="#" onclick="openInvoiceAndPrint('<%= lastOrderId %>')" class="btn btn-secondary ms-2">Print Invoice</a>
  <% } else { %>
    <a id="printInvoiceBtn" href="#" onclick="openInvoiceAndPrint(window.__latestOrderId)" class="btn btn-secondary ms-2" style="display:none;">Print Invoice</a>
  <% } %>
  <a href="/shopping" class="btn btn-outline ms-2">Continue Shopping</a>
</div>
<% if (!(typeof lastOrderId !== 'undefined' && lastOrderId)) { %>
<script>
// Attempt to fetch latest order and enable Print Invoice button
fetch('/api/orders')
  .then(r => r.ok ? r.json() : Promise.reject())
  .then(data => {
    if (!data || !data.orders || !data.orders.length) return;
    const latest = data.orders.reduce((m,o) => (!m || o.id > m.id) ? o : m, null);
    if (!latest) return;
    window.__latestOrderId = latest.id;
    const btn = document.getElementById('printInvoiceBtn');
    if (btn) {
      btn.style.display = 'inline-block';
    }
  })
  .catch(()=>{});

function openInvoiceAndPrint(orderId) {
  if (!orderId) return;
  const url = '/orders/' + orderId + '/invoice?auto=1';
  // Navigate to the summary invoice and let it auto-print
  window.location.href = url;
}
</script>
<% } %>
<%- include('partials/footer') %>
