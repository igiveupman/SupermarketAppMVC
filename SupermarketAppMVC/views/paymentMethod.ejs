<% /* Payment method page: choose PayNow or card; submits to /purchase which triggers checkout */ %>
<%- include('partials/header', { user, pageTitle: 'Payment' }) %>
<h2 class="mb-3">Purchase</h2>
<p class="text-muted mb-4">Select a payment method and confirm your purchase.</p>
<% if (cart && cart.length) { %>
  <h5 class="mb-3">Order Summary</h5>
  <ul class="list-group mb-4">
    <% let total = 0; cart.forEach(i => { total += i.price * i.quantity; %>
      <li class="list-group-item d-flex justify-content-between"><span><%= i.productName %> × <%= i.quantity %></span><span>$<%= (i.price * i.quantity).toFixed(2) %></span></li>
    <% }) %>
    <li class="list-group-item d-flex justify-content-between fw-semibold"><span>Total</span><span>$<%= total.toFixed(2) %></span></li>
  </ul>
<% } %>
<form action="/purchase" method="POST" class="payment-form" id="paymentForm">
  <div class="mb-3">
    <label class="form-label fw-semibold">Payment Method</label>
    <div class="d-flex flex-wrap gap-3">
      <div class="form-check">
        <input class="form-check-input" type="radio" name="method" id="methodCard" value="card" checked>
        <label class="form-check-label" for="methodCard">Credit / Debit Card</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="method" id="methodPayNow" value="paynow">
        <label class="form-check-label" for="methodPayNow">PayNow</label>
      </div>
    </div>
  </div>
  <div id="cardFields" class="card-fields">
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label">Card Number</label>
        <input type="text" name="card_number" class="form-control" maxlength="19" placeholder="xxxx xxxx xxxx xxxx" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Expiry (MM/YY)</label>
        <input type="text" name="expiry" class="form-control" maxlength="5" placeholder="MM/YY" />
      </div>
      <div class="col-md-3">
        <label class="form-label">CVV</label>
        <input type="password" name="cvv" class="form-control" maxlength="4" placeholder="123" />
      </div>
    </div>
  </div>
  <div id="paynowFields" class="paynow-fields mb-3" style="display:none;">
    <p class="small text-muted mb-2">Scan the QR code below.</p>
    <img src="/images/qr.png" alt="PayNow QR Code" style="width:220px; height:auto; border:1px solid #e2e8f0; padding:10px; background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08);" />
  </div>
  <div id="paynowSection" class="border rounded p-3 mb-3" style="display:none; background:#fff;">
    <p class="mb-2 fw-semibold">Scan the PayNow QR code below with your banking app to complete payment.</p>
    <img src="/images/qr.png" alt="PayNow QR Code" style="max-width:220px; width:100%; border:1px solid #e2e8f0; border-radius:12px; padding:10px; background:#f8fafc;" />
    <p class="small text-muted mt-2">After paying, click Confirm Payment to finalize your order.</p>
  </div>
  <div class="mb-3">
    <label class="form-label fw-semibold">Delivery Information</label>
    <div class="row g-3">
      <div class="col-md-8">
        <label class="form-label">Delivery Address</label>
        <input type="text" name="delivery_address" class="form-control" placeholder="Block, Street, Unit, Postal" value="<%= (user && user.address) ? user.address : '' %>" required />
      </div>
      <div class="col-md-4">
        <label class="form-label">Contact Number</label>
        <input type="text" name="delivery_contact" class="form-control" placeholder="e.g., 9123 4567" value="<%= (user && user.contact) ? user.contact : '' %>" />
      </div>
    </div>
    <p class="small text-muted mt-2">We’ll use this address to deliver your items. Please verify or update if needed.</p>
  </div>
  <button type="submit" class="btn btn-primary">Confirm Payment</button>
  <a href="/cart" class="btn btn-outline ms-2">Back to Cart</a>
</form>
<script>
  (function(){
    const cardRadio = document.getElementById('methodCard');
    const paynowRadio = document.getElementById('methodPayNow');
    const cardFields = document.getElementById('cardFields');
  const paynowFields = document.getElementById('paynowFields');
    function sync(){
      if(paynowRadio.checked){
    cardFields.style.display='none';
    paynowFields.style.display='block';
    cardFields.querySelectorAll('input').forEach(i=> i.removeAttribute('required'));
      } else {
        cardFields.style.display='block';
    paynowFields.style.display='none';
        cardFields.querySelectorAll('input').forEach(i=> i.setAttribute('required','required'));
      }
    }
    cardRadio.addEventListener('change', sync);
    paynowRadio.addEventListener('change', sync);
    sync();
  })();
</script>
<%- include('partials/footer') %>
