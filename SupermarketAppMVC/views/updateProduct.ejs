<%- include('partials/header', { user, pageTitle: 'Update Product' }) %>
  <div class="container-narrow">
    <h2 class="text-center mb-4">Update Product</h2>
    
    <% if (product) { %>
      <% if (errors && errors.length) { %>
        <div class="alert alert-danger"><%= errors.join(', ') %></div>
      <% } %>
      <% if (messages && messages.length) { %>
        <div class="alert alert-success"><%= messages.join(', ') %></div>
      <% } %>
      <form action="/updateProduct/<%= product.id %>" method="POST" enctype="multipart/form-data" class="mx-auto" style="max-width: 500px;">
        
        <div class="mb-3">
          <label for="name" class="form-label">Product Name</label>
          <input type="text" class="form-control" id="name" name="name" value="<%= product.productName %>" required>
        </div>

        <div class="mb-3">
          <label for="quantity" class="form-label">Quantity</label>
          <input type="number" class="form-control" id="quantity" name="quantity" min="0" step="1" value="<%= product.quantity %>" required>
        </div>

        <div class="mb-3">
          <label for="price" class="form-label">Price</label>
          <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" value="<%= Number(product.price).toFixed(2) %>" required>
        </div>

        <div class="mb-3">
          <label for="discount_percent" class="form-label">Discount (%) (optional)</label>
          <% 
            const dPrice = product.discount_price ? Number(product.discount_price) : null; 
            const fullPrice = Number(product.price);
            const dPercent = (dPrice !== null && fullPrice > 0) ? ((1 - (dPrice / fullPrice)) * 100) : '';
          %>
          <input type="number" class="form-control" id="discount_percent" name="discount_percent" min="0" max="100" step="0.01" value="<%= dPercent !== '' ? dPercent.toFixed(2) : '' %>" placeholder="e.g. 15">
          <small class="text-muted">Enter the percentage off the original price. Leave blank for no discount.</small>
          <div class="small text-muted mt-1" id="discountPreviewUpdate" style="display:none;"></div>
        </div>

        <div class="mb-3">
          <label for="category" class="form-label">Category</label>
          <select id="category" name="category" class="form-control" required>
            <option value="Bakery" <%= product.category === 'Bakery' ? 'selected' : '' %>>Bakery</option>
            <option value="Dairy" <%= product.category === 'Dairy' ? 'selected' : '' %>>Dairy</option>
            <option value="Produce" <%= product.category === 'Produce' ? 'selected' : '' %>>Fruits and Vegetables</option>
            <option value="Meats" <%= product.category === 'Meats' ? 'selected' : '' %>>Meats</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Current Image</label>
          <input type="text" class="form-control" name="currentImage" value="<%= product.image %>" readonly>
          <img src="/images/<%= product.image %>" class="img-thumbnail mt-2" style="width: 150px;">
        </div>

        <div class="mb-4">
          <label for="image" class="form-label">Upload New Image</label>
          <input class="form-control" type="file" id="image" name="image" accept="image/*">
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary">Update Product</button>
          <a href="/inventory" class="btn btn-secondary">Back to Inventory</a>
        </div>
      </form>
    <% } else { %>
      <p class="text-center">No product found.</p>
    <% } %>
  </div>
<script>
  (function(){
    const priceEl = document.getElementById('price');
    const pctEl = document.getElementById('discount_percent');
    const out = document.getElementById('discountPreviewUpdate');
    if(!priceEl || !pctEl || !out) return;
    function render(){
      const p = parseFloat(priceEl.value);
      const d = parseFloat(pctEl.value);
      if(isFinite(p) && isFinite(d)){
        const final = Math.max(0, p * (1 - Math.min(100, Math.max(0,d))/100));
        out.style.display='';
        out.innerText = `Final price after ${d.toFixed(2)}%: $${final.toFixed(2)} (was $${p.toFixed(2)})`;
      } else {
        out.style.display='none';
        out.innerText='';
      }
    }
    priceEl.addEventListener('input', render);
    pctEl.addEventListener('input', render);
    render();
  })();
</script>
<%- include('partials/footer') %>
