<% /* Shopping page header: includes FairPrice-inspired navbar */ %>
<%- include('partials/header', { user, pageTitle: 'Shop', currentPage: 'shopping' }) %>
<% const __trendingMode = (typeof trendingMode !== 'undefined') ? trendingMode : false; %>
<div class="mb-2">Welcome, <strong><%= user.username %></strong> <small class="text-muted">(<%= user.role %>)</small></div>
<h2 class="fw-semibold">Products</h2>
<% if (__trendingMode) { %>
  <h5 class="mt-1 text-primary">Showing trending (featured) products only.</h5>
<% } %>
<% /* Category widgets (chips). Clicking active one again clears its filter. */ %>
<div class="action-widgets mb-3 category-widgets">
  <% const categories = [
    { key: '', label: 'All', icon: 'ðŸ§º' },
    { key: 'Bakery', label: 'Bakery', icon: 'ðŸ¥–' },
    { key: 'Dairy', label: 'Dairy', icon: 'ðŸ¥›' },
    { key: 'Produce', label: 'Fruits & Veg', icon: 'ðŸ¥¬' },
    { key: 'Meats', label: 'Meats', icon: 'ðŸ—' }
  ]; %>
  <% const buildQuery = (params) => {
       const parts = [];
       if (params.category) parts.push('category=' + encodeURIComponent(params.category));
       if (params.search) parts.push('search=' + encodeURIComponent(params.search));
       if (params.trending) parts.push('trending=1');
       return parts.length ? '?' + parts.join('&') : '';
     }; %>
  <!-- Trending widget: toggles featured-only mode -->
  <a class="widget <%= __trendingMode ? 'active' : '' %>" href="/shopping<%= __trendingMode ? buildQuery({ search, category }) : buildQuery({ trending: true, search, category }) %>" aria-label="Toggle trending products">
    <div class="widget-icon">ðŸ”¥</div>
    <div class="widget-body">
      <h4>Trending</h4>
    </div>
  </a>
  <% categories.forEach(c => { %>
  <a class="widget <%= (category === c.key || (!category && c.key === '')) ? 'active' : '' %>" href="/shopping<%= (category === c.key) ? buildQuery({ search, trending: __trendingMode }) : buildQuery({ category: c.key, search, trending: __trendingMode }) %>" aria-label="Filter by <%= c.label %>">
      <div class="widget-icon"><%= c.icon %></div>
      <div class="widget-body">
        <h4><%= c.label %></h4>
      </div>
    </a>
  <% }) %>
</div>
<% /* Filter bar: search, category dropdown, trending checkbox */ %>
<form class="row g-3 align-items-center" method="GET" action="/shopping">
  <div class="col-md-4 col-sm-12">
    <input type="text" name="search" class="form-control" placeholder="Search products..." value="<%= typeof search !== 'undefined' ? search : '' %>">
  </div>
  <div class="col-md-3 col-sm-6">
    <select name="category" class="form-control">
      <option value="">All Categories</option>
      <option value="Bakery" <%= category === 'Bakery' ? 'selected' : '' %>>Bakery</option>
      <option value="Dairy" <%= category === 'Dairy' ? 'selected' : '' %>>Dairy</option>
      <option value="Fruits and Vegetables" <%= (category === 'Produce' || category === 'Fruits and Vegetables') ? 'selected' : '' %>>Fruits and Vegetables</option>
      <option value="Meats" <%= category === 'Meats' ? 'selected' : '' %>>Meats</option>
    </select>
  </div>
  <div class="col-md-3 col-sm-6">
    <div class="form-check mt-1">
      <input class="form-check-input" type="checkbox" name="trending" value="1" id="trendingCheck" <%= __trendingMode ? 'checked' : '' %> />
      <label class="form-check-label" for="trendingCheck">Trending only</label>
    </div>
  </div>
  <div class="col-md-2 col-sm-6">
    <button type="submit" class="btn btn-primary w-100">Filter</button>
  </div>
</form>
<% /* Product cards grid; shows a trending section when not in trendingMode */ %>
<div class="products-grid">
  <% if (!__trendingMode && typeof trendingProducts !== 'undefined' && trendingProducts.length) { %>
    <div style="grid-column:1/-1">
      <h3 class="mt-4 mb-2">ðŸ”¥ Trending Products</h3>
      <div class="products-grid trending-grid">
        <% trendingProducts.forEach(tp => { %>
          <%- include('partials/productCard', { p: tp, user, showFavorite: true, clickable: true, returnTo: '/shopping' }) %>
        <% }) %>
      </div>
      <hr class="mt-4">
    </div>
  <% } %>
  <% if (__trendingMode && products.length === 0) { %>
    <div style="grid-column:1/-1" class="center muted mt-4">No trending products right now.</div>
  <% } %>
  <% products.forEach(p => { %>
    <%- include('partials/productCard', { p, user, showFavorite: true, clickable: true, returnTo: '/shopping' }) %>
  <% }) %>
</div>
<% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
  <nav class="mt-4">
    <ul class="pagination">
      <li class="page-item <%= page === 1 ? 'disabled' : '' %>">
  <a class="page-link" href="/shopping?page=<%= page - 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= category ? '&category=' + encodeURIComponent(category) : '' %><%= __trendingMode ? '&trending=1' : '' %>" tabindex="-1">Previous</a>
      </li>
      <% for (let i=1;i<= totalPages;i++){ %>
        <li class="page-item <%= page === i ? 'active' : '' %>">
          <a class="page-link" href="/shopping?page=<%= i %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= category ? '&category=' + encodeURIComponent(category) : '' %><%= __trendingMode ? '&trending=1' : '' %>"><%= i %></a>
        </li>
      <% } %>
      <li class="page-item <%= page === totalPages ? 'disabled' : '' %>">
  <a class="page-link" href="/shopping?page=<%= page + 1 %><%= search ? '&search=' + encodeURIComponent(search) : '' %><%= category ? '&category=' + encodeURIComponent(category) : '' %><%= __trendingMode ? '&trending=1' : '' %>">Next</a>
      </li>
    </ul>
    <p class="text-muted small mt-2">Page <%= page %> of <%= totalPages %></p>
  </nav>
<% } %>
<%- include('partials/footer') %>
<script src="/js/cartAjax.js"></script>
<script>
  document.addEventListener('click', function(e){
    const card = e.target.closest('.product-card.clickable');
    if (!card) return;
    // ignore if clicking interactive elements
    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('form')) return;
    let link = card.getAttribute('data-link');
    if (link) {
      // Strip accidental wrapping quotes ("/product/21" or '/product/21')
      if ((link.startsWith('"') && link.endsWith('"')) || (link.startsWith("'") && link.endsWith("'"))) {
        link = link.slice(1, -1);
      }
      window.location.assign(link);
    }
  });
  // Client-side quantity validation for all qty inputs on shopping page
  document.addEventListener('input', function(e){
    if (e.target.matches('.qty-input')) {
      const maxAttr = e.target.getAttribute('data-max') || e.target.getAttribute('max');
      const max = parseInt(maxAttr,10) || 0;
      const val = parseInt(e.target.value,10) || 0;
      if (val > max) {
        e.target.classList.add('is-invalid');
        if (!e.target.nextElementSibling || !e.target.nextElementSibling.classList.contains('qty-error')) {
          const msg = document.createElement('div');
          msg.className = 'qty-error text-danger small';
          msg.textContent = 'Not enough stock (max ' + max + ').';
          e.target.parentNode.appendChild(msg);
        } else {
          e.target.nextElementSibling.textContent = 'Not enough stock (max ' + max + ').';
        }
      } else {
        e.target.classList.remove('is-invalid');
        if (e.target.nextElementSibling && e.target.nextElementSibling.classList.contains('qty-error')) {
          e.target.nextElementSibling.remove();
        }
      }
    }
  });
  document.addEventListener('submit', function(e){
    if (e.target.matches('form[action^="/add-to-cart/"]')) {
      const input = e.target.querySelector('.qty-input');
      if (input) {
        const maxAttr = input.getAttribute('data-max') || input.getAttribute('max');
        const max = parseInt(maxAttr,10) || 0;
        const val = parseInt(input.value,10) || 0;
        if (val > max) {
          e.preventDefault();
          alert('Not enough stock. Available: ' + max);
        }
      }
    }
  });
</script>
<style>
.favorite-toggle { text-decoration:none; }
.heart { font-size:1.2rem; color:#94a3b8; transition:.2s; }
.heart.favorited { color:#e11d48; }
.heart:hover { transform:scale(1.15); color:#e11d48; }
.pagination .page-link { color:#2563eb; }
.pagination .page-item.active .page-link { background:#2563eb; border-color:#2563eb; }
.product-card.clickable { cursor:pointer; position:relative; }
.product-card.clickable:hover { box-shadow:0 0 0 2px #2563eb33; }
 .qty-error { margin-top:4px; }
 .is-invalid { border-color:#dc2626; }
</style>
